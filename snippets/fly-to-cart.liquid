<link rel="stylesheet" href="{{ 'fly-to-cart.css' | asset_url }}" media="all">

<div id="cart-popup" class="cart-popup">
  <span>Item added to your cart!</span>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const popup = document.getElementById('cart-popup')

    document.body.addEventListener('click', (event) => {
      const addToCartBtn = event.target.closest(
        'form[action="/cart/add"] [type="submit"], .product-form__submit, button[name="add"]',
      )
      if (!addToCartBtn) return

      const productForm = addToCartBtn.closest('form')
      if (!productForm) return

      let productImage

      if (window.innerWidth >= 768) {
        productImage = Array.from(productForm.querySelectorAll('img')).find(
          (img) => img.offsetParent !== null,
        )
      } else {
        const activeSlide = document.querySelector('.swiper-slide-active img')
        if (activeSlide) productImage = activeSlide
      }

      // fallback: first visible product image anywhere
      if (!productImage) {
        productImage = Array.from(
          document.querySelectorAll('.product--medias img'),
        ).find((img) => img.offsetParent !== null)
      }

      if (!productImage) return

      // Find the visible cart button
      const cartLink = Array.from(
        document.querySelectorAll('a[href="{{ routes.cart_url }}"]'),
      ).find((el) => el.offsetParent !== null)
      if (!cartLink) return

      const imgRect = productImage.getBoundingClientRect()
      const cartRect = cartLink.getBoundingClientRect()

      const flyingImg = productImage.cloneNode(true)
      flyingImg.classList.add('fly-image')
      flyingImg.style.left = `${imgRect.left}px`
      flyingImg.style.top = `${imgRect.top}px`
      flyingImg.style.width = `${imgRect.width}px`
      flyingImg.style.height = `${imgRect.height}px`
      document.body.appendChild(flyingImg)

      requestAnimationFrame(() => {
        flyingImg.style.left = `${cartRect.left + cartRect.width / 2 - 20}px`
        flyingImg.style.top = `${cartRect.top + cartRect.height / 2 - 20}px`
        flyingImg.style.width = '40px'
        flyingImg.style.height = '40px'
        flyingImg.style.opacity = '0.3'
        flyingImg.style.transform = 'rotate(20deg)'
      })

      flyingImg.addEventListener('transitionend', () => {
        flyingImg.remove()
        if (popup) {
          popup.classList.add('show')
          setTimeout(() => popup.classList.remove('show'), 2000)
        }
      })
    })
  })
</script>
